From 183c73086b7374403def75c7cf5e373111e02908 Mon Sep 17 00:00:00 2001
From: sameeul <sameeul@gmail.com>
Date: Tue, 1 Nov 2022 16:25:59 -0400
Subject: [PATCH] Fix Win CUDA Build

---
 CMakeLists.txt       | 101 +++++++++++++++++++++++++++----------------
 tests/CMakeLists.txt |  43 ++++++++++++------
 2 files changed, 92 insertions(+), 52 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 4a845e1..a9eb26d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -5,21 +5,35 @@ project(AxleNyxus)
 if(DEFINED ENV{NYXUS_DEP_DIR})
 	set(CMAKE_PREFIX_PATH $ENV{NYXUS_DEP_DIR})
 endif()
-
-find_package(CUDA)
+find_package(CUDAToolkit)
 option(USEGPU "Use GPU" ON)
-if(CUDA_FOUND AND USEGPU)
+
+if(CUDAToolkit_FOUND AND USEGPU)
 	set(USEGPU ON)
-	if (CUDA_VERSION_MAJOR STREQUAL "10")
-		set(CUDA_ARCH_LIST "35;37;50;72;75")
-	elseif (CUDA_VERSION_MAJOR STREQUAL "11")
-		if(CUDA_VERSION_MINOR STREQUAL "0")
+	if (CUDAToolkit_VERSION_MAJOR STREQUAL "10")
+		if(WIN32)
+			set(CUDA_ARCH_LIST "35;37;50;72")
+		else()
 			set(CUDA_ARCH_LIST "35;37;50;72;75")
-		elseif (CUDA_VERSION_MINOR STREQUAL "1" OR CUDA_VERSION_MINOR STREQUAL "2")
-			set(CUDA_ARCH_LIST "35;37;50;72;75;80;86")
 		endif()
+	elseif (CUDAToolkit_VERSION_MAJOR STREQUAL "11")
+		if(CUDAToolkit_VERSION_MINOR STREQUAL "0")
+			if(WIN32)
+				set(CUDA_ARCH_LIST "35;37;50;72")
+			else()
+				set(CUDA_ARCH_LIST "35;37;50;72;75")
+			endif()
+		elseif (CUDAToolkit_VERSION_MINOR STREQUAL "1" OR CUDAToolkit_VERSION_MINOR STREQUAL "2")
+			if(WIN32)
+				set(CUDA_ARCH_LIST "35;37;50;72;75;80")
+			else()
+				set(CUDA_ARCH_LIST "35;37;50;72;75;80;86")
+			endif()
+		endif()
+	else()
+		set(CUDA_ARCH_LIST "50") # default
 	endif()
-elseif((NOT CUDA_FOUND) AND USEGPU)
+elseif((NOT CUDAToolkit_FOUND) AND USEGPU)
 	message(WARNING "CUDA not found. USEGPU flag will be ignored.")
 	set(USEGPU OFF)
 else()
@@ -33,20 +47,25 @@ set(CMAKE_CXX_STANDARD_REQUIRED ON)
 
 if(USEGPU)
     enable_language("CUDA")
+	SET(CMAKE_CUDA_ARCHITECTURES ${CUDA_ARCH_LIST})
+	set_property(GLOBAL PROPERTY CUDA_ARCHITECTURES "${CUDA_ARCH_LIST}")
+	message("Building with compute capability for ${CUDA_ARCH_LIST}.")
     add_definitions(-DUSE_GPU)
-	if (CUDA_VERSION_MAJOR STREQUAL "10")
+	if (CUDAToolkit_VERSION_MAJOR STREQUAL "10")
 		set(CMAKE_CUDA_STANDARD 14)
-	elseif (CUDA_VERSION_MAJOR STREQUAL "11")
+	elseif (CUDAToolkit_VERSION_MAJOR STREQUAL "11")
 		set(CMAKE_CUDA_STANDARD 17)
 	endif()
 	set(CMAKE_CUDA_STANDARD_REQUIRED ON)	
 endif()
 
 #since xtensor does not built with GCC 7.5 and lower
+option(OMEZARR "Support OMEZarr" ON)
 if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
 	if(CMAKE_CXX_COMPILER_VERSION VERSION_GREATER 7.5) 
 		add_definitions(-DOMEZARR_SUPPORT)
 	else()
+		set(OMEZARR OFF)
 		message(WARNING "OMEZarr support is not available with GCC 7.5 and older compiler.")
 	endif()
 else()
@@ -165,30 +184,32 @@ if (TIFF_FOUND)
 endif (TIFF_FOUND)
 
 #== Required for OMEZarr 
-find_package(BLOSC REQUIRED)
-if(BLOSC_FOUND)
-	target_compile_definitions(backend PRIVATE -DWITH_BLOSC)
-	target_link_libraries(backend PRIVATE ${BLOSC_LIBRARIES})
-	if(BUILD_CLI)
-		target_compile_definitions(nyxus PRIVATE -DWITH_BLOSC)
-		target_compile_definitions(nyxushie PRIVATE -DWITH_BLOSC) 	
-		target_link_libraries(nyxus PRIVATE ${BLOSC_LIBRARIES})	
-		target_link_libraries(nyxushie PRIVATE ${BLOSC_LIBRARIES})	
+if(OMEZARR)
+	find_package(BLOSC REQUIRED)
+	if(BLOSC_FOUND)
+		target_compile_definitions(backend PRIVATE -DWITH_BLOSC)
+		target_link_libraries(backend PRIVATE ${BLOSC_LIBRARIES})
+		if(BUILD_CLI)
+			target_compile_definitions(nyxus PRIVATE -DWITH_BLOSC)
+			target_compile_definitions(nyxushie PRIVATE -DWITH_BLOSC) 	
+			target_link_libraries(nyxus PRIVATE ${BLOSC_LIBRARIES})	
+			target_link_libraries(nyxushie PRIVATE ${BLOSC_LIBRARIES})	
+		endif()
 	endif()
+	
+	find_package(Boost REQUIRED)
+	if(Boost_FOUND)
+		include_directories(${Boost_INCLUDE_DIR})
+	endif()
+	
+	find_package(nlohmann_json REQUIRED)
+	if(nlohmann_json_FOUND)
+		include_directories(${nlohmann_json_INCLUDE_DIR})
+	endif()
+	
+	find_file(Z5 "z5/z5.hxx" REQUIRED)	
 endif()
 
-find_package(Boost REQUIRED)
-if(Boost_FOUND)
-	include_directories(${Boost_INCLUDE_DIR})
-endif()
-
-find_package(nlohmann_json REQUIRED)
-if(nlohmann_json_FOUND)
-	include_directories(${nlohmann_json_INCLUDE_DIR})
-endif()
-
-find_file(Z5 "z5/z5.hxx" REQUIRED)
-
 find_package(Threads QUIET)
 if (Threads_FOUND)
     if (CMAKE_USE_PTHREADS_INIT)
@@ -200,6 +221,7 @@ else ()
 endif ()
 
 if(USEGPU)
+	include_directories("${CUDAToolkit_INCLUDE_DIRS}")
 	set(GPU_SOURCE_FILES
 		src/nyx/gpu/gpu_helpers.cu
 		src/nyx/gpu/image_moments.cu
@@ -210,14 +232,17 @@ if(USEGPU)
 	if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
 		target_compile_options(nyxus_gpu PRIVATE $<$<COMPILE_LANGUAGE:CUDA>:-fPIC>)
 	endif()
-
-	target_link_libraries(backend PRIVATE ${CUDA_LIBRARIES} ${CUDA_CUFFT_LIBRARIES})
-	set_target_properties(backend PROPERTIES CUDA_ARCHITECTURES ${CUDA_ARCH_LIST})
+	target_link_directories (backend PRIVATE ${CUDAToolkit_LIBRARY_DIR})
+	target_link_libraries(backend PRIVATE CUDA::cudart CUDA::cufft)
+	message("Building backend with compute capability for ${CUDA_ARCH_LIST}.")
+	set_target_properties(backend PROPERTIES CUDA_ARCHITECTURES "${CUDA_ARCH_LIST}")
 	target_link_libraries(backend PRIVATE nyxus_gpu)
 	if(BUILD_CLI)
 		target_link_libraries(nyxus PRIVATE nyxus_gpu)
-		target_link_libraries(nyxus PRIVATE ${CUDA_LIBRARIES} ${CUDA_CUFFT_LIBRARIES})
-		set_target_properties(nyxus PROPERTIES CUDA_ARCHITECTURES ${CUDA_ARCH_LIST})
+		message("Building Nyxus with compute capability for ${CUDA_ARCH_LIST}.")
+		target_link_directories (nyxus PRIVATE ${CUDAToolkit_LIBRARY_DIR})
+		target_link_libraries(nyxus PRIVATE CUDA::cudart CUDA::cufft)
+		set_target_properties(nyxus PROPERTIES CUDA_ARCHITECTURES "${CUDA_ARCH_LIST}")
 	endif()
 endif()
 
diff --git a/tests/CMakeLists.txt b/tests/CMakeLists.txt
index 7f0c9c7..9641c19 100755
--- a/tests/CMakeLists.txt
+++ b/tests/CMakeLists.txt
@@ -1,4 +1,4 @@
-cmake_minimum_required(VERSION 3.12)
+cmake_minimum_required(VERSION 3.20)
 
 set (CMAKE_CXX_STANDARD 17)
 
@@ -10,28 +10,41 @@ set(CMAKE_CXX_STANDARD_REQUIRED True)
 include_directories(${CMAKE_SOURCE_DIR})
 include_directories(${gtest_SOURCE_DIR}/include ${gtest_SOURCE_DIR})
 
+find_package(CUDAToolkit)
 option(USEGPU "Use GPU" ON)
-find_package(CUDA)
 
-if(CUDA_FOUND AND USEGPU)
+if(CUDAToolkit_FOUND AND USEGPU)
 	set(USEGPU ON)
-	if (CUDA_VERSION_MAJOR STREQUAL "10")
-		set(CUDA_ARCH_LIST "35;37;50;72;75")
-	elseif (CUDA_VERSION_MAJOR STREQUAL "11")
-		if(CUDA_VERSION_MINOR STREQUAL "0")
+	if (CUDAToolkit_VERSION_MAJOR STREQUAL "10")
+		if(WIN32)
+			set(CUDA_ARCH_LIST "35;37;50;72")
+		else()
 			set(CUDA_ARCH_LIST "35;37;50;72;75")
-		elseif (CUDA_VERSION_MINOR STREQUAL "1" OR CUDA_VERSION_MINOR STREQUAL "2")
-			set(CUDA_ARCH_LIST "35;37;50;72;75;80;86")
 		endif()
+	elseif (CUDAToolkit_VERSION_MAJOR STREQUAL "11")
+		if(CUDAToolkit_VERSION_MINOR STREQUAL "0")
+			if(WIN32)
+				set(CUDA_ARCH_LIST "35;37;50;72")
+			else()
+				set(CUDA_ARCH_LIST "35;37;50;72;75")
+			endif()
+		elseif (CUDAToolkit_VERSION_MINOR STREQUAL "1" OR CUDAToolkit_VERSION_MINOR STREQUAL "2")
+			if(WIN32)
+				set(CUDA_ARCH_LIST "35;37;50;72;75;80")
+			else()
+				set(CUDA_ARCH_LIST "35;37;50;72;75;80;86")
+			endif()
+		endif()
+	else()
+		set(CUDA_ARCH_LIST "50") # default
 	endif()
-elseif((NOT CUDA_FOUND) AND USEGPU)
+elseif((NOT CUDAToolkit_FOUND) AND USEGPU)
 	message(WARNING "CUDA not found. USEGPU flag will be ignored.")
 	set(USEGPU OFF)
 else()
 	set(USEGPU OFF) # probably redundant fail-safe
 endif()
 
-
 set(TEST_SRC
 	test_all.cc
 	test_pixel_intensity_features.h
@@ -111,12 +124,14 @@ if(USEGPU)
 	)
 
 	target_sources(runAllTests PRIVATE ${GPU_SOURCE_FILES})
-	
+	include_directories("${CUDAToolkit_INCLUDE_DIRS}")
 	if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
 		target_compile_options(runAllTests PRIVATE $<$<COMPILE_LANGUAGE:CUDA>:-fPIC>)
 	endif()
-	target_link_libraries(runAllTests PRIVATE ${CUDA_LIBRARIES} ${CUDA_CUFFT_LIBRARIES})
-	set_target_properties(runAllTests PROPERTIES CUDA_ARCHITECTURES ${CUDA_ARCH_LIST})
+	target_link_directories (runAllTests PRIVATE ${CUDAToolkit_LIBRARY_DIR})
+	target_link_libraries(runAllTests PRIVATE CUDA::cudart CUDA::cufft)
+	message("Building tests with compute capability for ${CUDA_ARCH_LIST}.")
+	set_target_properties(runAllTests PROPERTIES CUDA_ARCHITECTURES "${CUDA_ARCH_LIST}")
 
 endif()
 
-- 
2.30.2

